#!/bin/sh

#set -e

# initramfs-tools header

PREREQ=""

prereqs()
{
	echo "${PREREQ}"
}

case "${1}" in
	prereqs)
		prereqs
		exit 0
		;;
esac

# live-initramfs header

. /scripts/live-functions

log_begin_msg "Setting up automatic login..."

# live-initramfs script

if [ -n "${NOXAUTOLOGIN}" ]
then
	exit 0
fi

# chroot needed to handle symlinks correctly
if chroot /root [ -f /etc/gdm/gdm-cdd.conf ]
then
	GDMCONF=/etc/gdm/gdm-cdd.conf
else
	GDMCONF=/etc/gdm/gdm.conf
fi

# chroot needed to handle symlinks correctly
if chroot /root [ -f ${GDMCONF} ]
then
	if [ "${BUILD_SYSTEM}" = "Debian" ]
	then
		# true hack ! -- nohar
		chroot /root cp /usr/share/gdm/defaults.conf /etc/gdm/gdm.conf
	fi

	# Configure GDM autologin
	chroot /root \
	sed -i -e "s/^AutomaticLoginEnable=.*\$/AutomaticLoginEnable=true/" \
	       -e "s/^AutomaticLogin=.*\$/AutomaticLogin=${USERNAME}/" \
	       -e "s/^TimedLoginEnable=.*\$/TimedLoginEnable=true/" \
	       -e "s/^TimedLogin=.*\$/TimedLogin=${USERNAME}/" \
	       -e "s/^TimedLoginDelay=.*\$/TimedLoginDelay=10/" \
	${GDMCONF}
fi

if [ -f /root/etc/kde3/kdm/kdmrc ]
then
	# Configure KDM autologin
	sed -i -r -e "s/^#?AutoLoginEnable=.*\$/AutoLoginEnable=true/" \
		  -e "s/^#?AutoLoginUser=.*\$/AutoLoginUser=${USERNAME}/" \
		  -e "s/^#?AutoReLogin=.*\$/AutoReLogin=true/" \
	/root/etc/kde3/kdm/kdmrc
fi

log_end_msg
